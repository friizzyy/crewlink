// Prisma schema for CrewLink
// Supports PostgreSQL (Neon/Supabase) for Vercel deployment

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTHENTICATION (NextAuth compatible)
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// USER & PROFILES
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  password      String?   // Hashed password for credentials auth
  phone         String?   @unique
  avatarUrl     String?
  role          String    @default("hirer") // hirer or worker
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Auth relations
  accounts      Account[]
  sessions      Session[]

  // Profiles
  workerProfile WorkerProfile?
  hirerProfile  HirerProfile?

  // Relations
  jobs               Job[]              @relation("JobPoster")
  bids               Bid[]
  bookingsAsHirer    Booking[]          @relation("BookingHirer")
  bookingsAsWorker   Booking[]          @relation("BookingWorker")
  reviewsGiven       Review[]           @relation("ReviewAuthor")
  reviewsReceived    Review[]           @relation("ReviewSubject")
  messagesSent       Message[]          @relation("MessageSender")
  messageThreads     ThreadParticipant[]
  notifications      Notification[]
  paymentRecords     PaymentRecord[]
}

model WorkerProfile {
  id              String    @id @default(cuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Professional info
  headline        String?
  bio             String?
  hourlyRate      Float?
  skills          String[]  @default([])

  // Verification
  isVerified      Boolean   @default(false)
  verificationStatus String @default("pending")
  idDocumentUrl   String?
  backgroundCheckStatus String @default("none")

  // Service area
  serviceRadius   Float     @default(25)
  baseLat         Float?
  baseLng         Float?
  baseAddress     String?

  // Stats
  completedJobs   Int       @default(0)
  totalEarnings   Float     @default(0)
  averageRating   Float     @default(0)
  responseRate    Float     @default(100)

  // Settings
  isActive        Boolean   @default(true)
  instantBook     Boolean   @default(false)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  availability    AvailabilityWindow[]
}

model HirerProfile {
  id              String    @id @default(cuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Info
  companyName     String?
  bio             String?

  // Location
  defaultLat      Float?
  defaultLng      Float?
  defaultAddress  String?

  // Stats
  totalJobsPosted Int       @default(0)
  totalSpent      Float     @default(0)
  averageRating   Float     @default(0)

  // Verification
  isVerified      Boolean   @default(false)
  paymentVerified Boolean   @default(false)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// ============================================
// AVAILABILITY
// ============================================

model AvailabilityWindow {
  id              String    @id @default(cuid())
  workerProfileId String
  workerProfile   WorkerProfile @relation(fields: [workerProfileId], references: [id], onDelete: Cascade)

  dayOfWeek       Int
  startTime       String
  endTime         String
  isAvailable     Boolean   @default(true)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([workerProfileId, dayOfWeek])
}

// ============================================
// JOBS
// ============================================

model Job {
  id              String    @id @default(cuid())
  posterId        String
  poster          User      @relation("JobPoster", fields: [posterId], references: [id], onDelete: Cascade)

  // Basic info
  title           String
  description     String
  category        String
  skills          String[]  @default([])

  // Scope
  scopeRaw        String?
  scopeCleaned    String?

  // Location
  lat             Float
  lng             Float
  address         String
  city            String?
  isRemote        Boolean   @default(false)

  // Schedule
  scheduleType    String    @default("flexible")
  startDate       DateTime?
  endDate         DateTime?
  estimatedHours  Float?

  // Budget
  budgetType      String    @default("hourly")
  budgetMin       Float?
  budgetMax       Float?

  // Status: draft, posted, in_review, assigned, in_progress, completed, cancelled
  status          String    @default("draft")
  assignedWorkerId String?

  // Tracking
  viewCount       Int       @default(0)
  bidCount        Int       @default(0)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  bids            Bid[]
  bookings        Booking[]
  conversations   MessageThread[]

  @@index([status])
  @@index([category])
  @@index([lat, lng])
  @@index([posterId])
}

// ============================================
// BIDS
// ============================================

model Bid {
  id              String    @id @default(cuid())
  jobId           String
  job             Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  workerId        String
  worker          User      @relation(fields: [workerId], references: [id], onDelete: Cascade)

  // Offer
  amount          Float
  message         String?
  estimatedHours  Float?

  // Status: pending, accepted, rejected, withdrawn
  status          String    @default("pending")

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([jobId, workerId])
  @@index([jobId])
  @@index([workerId])
}

// ============================================
// BOOKINGS
// ============================================

model Booking {
  id              String    @id @default(cuid())
  jobId           String
  job             Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  hirerId         String
  hirer           User      @relation("BookingHirer", fields: [hirerId], references: [id], onDelete: Cascade)
  workerId        String
  worker          User      @relation("BookingWorker", fields: [workerId], references: [id], onDelete: Cascade)

  // Schedule
  scheduledStart  DateTime
  scheduledEnd    DateTime?
  actualStart     DateTime?
  actualEnd       DateTime?

  // Payment
  agreedAmount    Float
  finalAmount     Float?
  paymentStatus   String    @default("pending")

  // Status: confirmed, in_progress, completed, cancelled, disputed
  status          String    @default("confirmed")

  // Completion
  completedAt     DateTime?
  cancelledAt     DateTime?
  cancelReason    String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  payments        PaymentRecord[]
  reviews         Review[]
}

// ============================================
// REVIEWS
// ============================================

model Review {
  id              String    @id @default(cuid())
  bookingId       String
  booking         Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  authorId        String
  author          User      @relation("ReviewAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  subjectId       String
  subject         User      @relation("ReviewSubject", fields: [subjectId], references: [id], onDelete: Cascade)

  // Review content
  rating          Int
  title           String?
  content         String?

  // Specific ratings
  communicationRating  Int?
  qualityRating        Int?
  timelinessRating     Int?
  valueRating          Int?

  // Flags
  isPublic        Boolean   @default(true)
  response        String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([bookingId, authorId])
}

// ============================================
// MESSAGING
// ============================================

model MessageThread {
  id              String    @id @default(cuid())
  jobId           String?
  job             Job?      @relation(fields: [jobId], references: [id], onDelete: SetNull)

  // Metadata
  lastMessageAt   DateTime  @default(now())
  lastMessagePreview String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  participants    ThreadParticipant[]
  messages        Message[]
}

model ThreadParticipant {
  id              String    @id @default(cuid())
  threadId        String
  thread          MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Read status
  lastReadAt      DateTime?
  unreadCount     Int       @default(0)
  isMuted         Boolean   @default(false)

  createdAt       DateTime  @default(now())

  @@unique([threadId, userId])
}

model Message {
  id              String    @id @default(cuid())
  threadId        String
  thread          MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  senderId        String
  sender          User      @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)

  // Content
  content         String
  messageType     String    @default("text")
  metadata        Json?

  // Status
  isEdited        Boolean   @default(false)
  isDeleted       Boolean   @default(false)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([threadId])
}

// ============================================
// PAYMENTS
// ============================================

model PaymentRecord {
  id              String    @id @default(cuid())
  bookingId       String
  booking         Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Payment details
  amount          Float
  type            String
  status          String    @default("pending")

  // External reference
  externalId      String?
  provider        String?

  // Metadata
  description     String?
  metadata        Json?

  processedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Content
  type            String
  title           String
  body            String
  data            Json?
  actionUrl       String?

  // Status
  isRead          Boolean   @default(false)
  readAt          DateTime?

  createdAt       DateTime  @default(now())

  @@index([userId, isRead])
  @@index([userId, createdAt])
}

// ============================================
// REFERENCE DATA
// ============================================

model Skill {
  id              String    @id @default(cuid())
  name            String    @unique
  category        String
  iconName        String?
  isActive        Boolean   @default(true)

  createdAt       DateTime  @default(now())
}

model Category {
  id              String    @id @default(cuid())
  name            String    @unique
  slug            String    @unique
  iconName        String?
  description     String?
  isActive        Boolean   @default(true)
  sortOrder       Int       @default(0)

  createdAt       DateTime  @default(now())
}

model City {
  id              String    @id @default(cuid())
  name            String
  state           String
  slug            String    @unique
  lat             Float
  lng             Float
  isActive        Boolean   @default(true)
  jobCount        Int       @default(0)
  workerCount     Int       @default(0)

  createdAt       DateTime  @default(now())
}
